January 18th, 2025

Below is a **clean handover version** you can paste directly into a **new chat**, a **GitHub repo (`TODO.md`)**, or a **project management tool**.

It is written as a **standalone project brief + implementation plan**, with no conversational context required.

---

# FreeCAD Workbench – Material Library Implementation TODO

## Project Overview

Implement a **Material Library** for a FreeCAD workbench using:

- Python
- Qt (PySide)
- JSON persistence
- CRUD architecture
- Qt `QUndoStack` for Undo / Redo

The system must be:

- Modular and maintainable
- Safe (validated data, reversible operations)
- Scalable to layers and wall assemblies
- Compatible with FreeCAD workbench patterns

---

## Guiding Principles

- UI must never edit JSON directly
- All data changes go through CRUD functions
- Undo/Redo wraps CRUD using `QUndoCommand`
- Qt dialogs remain thin (logic lives elsewhere)
- Small, incremental tasks (1–1.5 hrs each)

---

## Phase 0 – Groundwork

### ☐ Task 0.1 – Define material schema

**Objective:** Lock down the material data structure.

- Define required fields: `uid`, `name`, `category`
- Define sub-dicts:

  - `physical`
  - `thermal`
  - `prefab`

- Define optional fields: `tags`, `notes`
- Write 1–2 example materials

**Deliverable:** Documented schema + example material dict
**Time:** 1–2 × 30 min blocks

---

### ☐ Task 0.2 – Create materials.json

**Objective:** Establish real persistence early.

- Create `resources/materials/materials.json`
- Add top-level `version` field
- Add 2–3 test materials
- Verify file path resolution in FreeCAD

**Deliverable:** Loadable JSON file
**Time:** 1 × 30 min block

---

## Phase 1 – Core Data Layer (No Qt)

### ☐ Task 1.1 – Implement JSON persistence

**Objective:** Reliable load/save layer.

- `init_database(path)`
- `load_material_database(path)`
- `save_material_database(path)`
- Handle missing / empty files

**Deliverable:** Stable persistence functions
**Time:** 2 × 30 min blocks

---

### ☐ Task 1.2 – Implement material creation & validation

**Objective:** Prevent invalid data.

- `create_material(...)`
- `validate_material(material)`
- Clear error reporting
- Simple sanity checks / assertions

**Deliverable:** Validated material objects
**Time:** 2 × 30 min blocks

---

### ☐ Task 1.3 – Implement CRUD API

**Objective:** Core database API.

- `add_material`
- `get_material`
- `update_material`
- `delete_material`
- `list_materials`

**Deliverable:** CRUD functions used by all UI
**Time:** 2 × 30 min blocks

---

## Phase 2 – Qt Read Path

### ☐ Task 2.1 – Implement MaterialTableModel

**Objective:** Qt model for viewing materials.

- Subclass `QAbstractTableModel`
- Columns: Name, Category, Tags
- Implement `rowCount`, `columnCount`, `data`
- Bind to `list_materials()`

**Deliverable:** Materials visible in Qt table
**Time:** 3 × 30 min blocks

---

### ☐ Task 2.2 – Create Material Library dialog shell

**Objective:** UI structure only.

- QDialog containing:

  - QTableView
  - Add / Edit / Delete / Close buttons

- Connect table to model
- No CRUD logic yet

**Deliverable:** Dialog opens cleanly
**Time:** 2 × 30 min blocks

---

## Phase 3 – CRUD Button Wiring (No Undo)

### ☐ Task 3.1 – Implement Add Material dialog

**Objective:** Create path end-to-end.

- Simple form (name, category, tags)
- Return material dict
- Call `add_material`
- Refresh model

**Deliverable:** Add button functional
**Time:** 3 × 30 min blocks

---

### ☐ Task 3.2 – Implement Edit Material dialog

**Objective:** Update path end-to-end.

- Populate form from selected material
- Apply changes via `update_material`
- Refresh model

**Deliverable:** Edit button functional
**Time:** 3 × 30 min blocks

---

### ☐ Task 3.3 – Implement Delete confirmation

**Objective:** Safe deletion.

- Confirmation dialog
- Call `delete_material`
- Refresh model

**Deliverable:** Delete button functional
**Time:** 1–2 × 30 min blocks

---

## Phase 4 – Undo / Redo Support

### ☐ Task 4.1 – Add QUndoStack to dialog

**Objective:** Infrastructure only.

- Create `self.undo_stack`
- Add Undo / Redo buttons
- Connect `canUndoChanged` / `canRedoChanged`

**Deliverable:** Undo/Redo UI wired
**Time:** 1–2 × 30 min blocks

---

### ☐ Task 4.2 – Implement AddMaterialCommand

**Objective:** Undoable creation.

- Subclass `QUndoCommand`
- Implement `redo()` and `undo()`
- Replace direct add logic with command push

**Deliverable:** Add supports Undo/Redo
**Time:** 2 × 30 min blocks

---

### ☐ Task 4.3 – Implement EditMaterialCommand

**Objective:** Undoable edits.

- Store old + new material state
- Implement `redo()` and `undo()`
- Replace edit logic

**Deliverable:** Edit supports Undo/Redo
**Time:** 2–3 × 30 min blocks

---

### ☐ Task 4.4 – Implement DeleteMaterialCommand

**Objective:** Undoable deletion.

- Cache deleted material
- Implement `redo()` and `undo()`
- Replace delete logic

**Deliverable:** Delete supports Undo/Redo
**Time:** 2 × 30 min blocks

---

## Phase 5 – FreeCAD Integration

### ☐ Task 5.1 – Register FreeCAD command

**Objective:** Workbench entry point.

- Create `BuildQ_MaterialLibrary` command
- Open dialog
- Register icon, tooltip, menu entry

**Deliverable:** Accessible from toolbar
**Time:** 1–2 × 30 min blocks

---

### ☐ Task 5.2 – Protect in-use materials

**Objective:** Prevent breaking models.

- Detect materials used in wall assemblies
- Block or warn on delete
- Document rule

**Deliverable:** Safe material lifecycle
**Time:** 2–3 × 30 min blocks

---

## Phase 6 – Polish & Future-Proofing

### ☐ Task 6.1 – Add search & filtering (READ only)

**Objective:** Scalable UX.

- Search box
- Category / tag filters
- Use proxy model

**Deliverable:** Large libraries usable
**Time:** 2–3 × 30 min blocks

---

### ☐ Task 6.2 – Database versioning & migration

**Objective:** Upgrade safety.

- Add database version checks
- Migration stub
- Log version mismatches

**Deliverable:** Future-proof database
**Time:** 1–2 × 30 min blocks

---

## Milestones

- **End Phase 3:** Fully functional material library
- **End Phase 4:** Professional-grade Undo/Redo
- **End Phase 5:** Fully integrated FreeCAD tool

---

## Notes

This architecture is designed to:

- Extend directly to Layer Libraries and Wall Assemblies
- Align with FreeCAD’s command-based workflow
- Support future automation and prefabrication logic

---

If you want next in the new chat, strong follow-ons are:

- Layer Library using the same CRUD + Undo pattern
- Material → Layer compatibility rules
- Document-level Undo integration with FreeCAD

You’re now set up to build this cleanly and incrementally.
